var RepeaterRow=function(e,t,i){"use strict";var r=this;this.rowIndex=e,this.container=t,this.label=i,this.header=this.container.find(".repeater-row-header"),this.header.on("click",(function(){r.toggleMinimize()})),this.container.on("click",".repeater-row-remove",(function(){r.remove()})),this.header.on("mousedown",(function(){r.container.trigger("row:start-dragging")})),this.container.on("keyup change","input, select, textarea",(function(e){r.container.trigger("row:update",[r.rowIndex,jQuery(e.target).data("field"),e.target])})),this.setRowIndex=function(e){this.rowIndex=e,this.container.attr("data-row",e),this.container.data("row",e),this.updateLabel()},this.toggleMinimize=function(){this.container.toggleClass("minimized"),this.header.find(".dashicons").toggleClass("dashicons-arrow-up").toggleClass("dashicons-arrow-down")},this.remove=function(){this.container.slideUp(300,(function(){jQuery(this).detach()})),this.container.trigger("row:remove",[this.rowIndex])},this.updateLabel=function(){var e,t;"field"!==this.label.type||"function"!=typeof(e=this.container.find('.repeater-field [data-field="'+this.label.field+'"]')).val||""===(t=e.val())?this.header.find(".repeater-row-label").text(this.label.value+" "+(this.rowIndex+1)):this.header.find(".repeater-row-label").text(t)},this.updateLabel()};wp.customize.controlConstructor.repeater=wp.customize.Control.extend({ready:function(){"use strict";var e,t,i=this,r=this.params.value;this.settingField=this.container.find("[data-customize-setting-link]").first(),this.setValue([],!1),this.repeaterFieldsContainer=this.container.find(".repeater-fields").first(),this.currentIndex=0,this.rows=[],e=!1,void 0!==this.params.choices.limit&&(e=!(0>=this.params.choices.limit)&&parseInt(this.params.choices.limit)),this.container.on("click","button.repeater-add",(function(r){r.preventDefault(),!e||i.currentIndex<e?((t=i.addRow()).toggleMinimize(),i.initColorPicker(),i.initDropdownPages(t)):jQuery(i.selector+" .limit").addClass("highlight")})),this.container.on("click",".repeater-row-remove",(function(t){i.currentIndex--,(!e||i.currentIndex<e)&&jQuery(i.selector+" .limit").removeClass("highlight")})),this.container.on("click keypress",".repeater-field-image .upload-button,.repeater-field-cropped_image .upload-button,.repeater-field-upload .upload-button",(function(e){e.preventDefault(),i.$thisButton=jQuery(this),i.openFrame(e)})),this.container.on("click keypress",".repeater-field-image .remove-button,.repeater-field-cropped_image .remove-button",(function(e){e.preventDefault(),i.$thisButton=jQuery(this),i.removeImage(e)})),this.container.on("click keypress",".repeater-field-upload .remove-button",(function(e){e.preventDefault(),i.$thisButton=jQuery(this),i.removeFile(e)})),this.repeaterTemplate=_.memoize((function(){var e={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(t){return _.template(i.container.find(".customize-control-repeater-content").first().html(),null,e)(t)}})),r.length&&_.each(r,(function(e){t=i.addRow(e),i.initColorPicker(),i.initDropdownPages(t,e)})),this.setValue(r,!0,!0),this.repeaterFieldsContainer.sortable({handle:".repeater-row-header",update:function(e,t){i.sort()}})},openFrame:function(e){"use strict";wp.customize.utils.isKeydownButNotEnterEvent(e)||(this.$thisButton.closest(".repeater-field").hasClass("repeater-field-cropped_image")?this.initCropperFrame():this.initFrame(),this.frame.open())},initFrame:function(){"use strict";var e=this.getMimeType();this.frame=wp.media({states:[new wp.media.controller.Library({library:wp.media.query({type:e}),multiple:!1,date:!1})]}),this.frame.on("select",this.onSelect,this)},initCropperFrame:function(){"use strict";var e=this.$thisButton.siblings("input.hidden-field").attr("data-field"),t=this.getMimeType();"string"==typeof e&&""!==e&&"object"==typeof this.params.fields[e]&&"cropped_image"===this.params.fields[e].type&&["width","height","flex_width","flex_height"].forEach(function(t,i){void 0!==this.params.fields[e][t]&&(this.params[t]=this.params.fields[e][t])}.bind(this)),this.frame=wp.media({button:{text:"Select and Crop",close:!1},states:[new wp.media.controller.Library({library:wp.media.query({type:t}),multiple:!1,date:!1,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.CustomizeImageCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]}),this.frame.on("select",this.onSelectForCrop,this),this.frame.on("cropped",this.onCropped,this),this.frame.on("skippedcrop",this.onSkippedCrop,this)},onSelect:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();this.$thisButton.closest(".repeater-field").hasClass("repeater-field-upload")?this.setFileInRepeaterField(e):this.setImageInRepeaterField(e)},onSelectForCrop:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();this.params.width!==e.width||this.params.height!==e.height||this.params.flex_width||this.params.flex_height?this.frame.setState("cropper"):this.setImageInRepeaterField(e)},onCropped:function(e){"use strict";this.setImageInRepeaterField(e)},calculateImageSelectOptions:function(e,t){"use strict";var i,r,s,a=t.get("control"),n=!!parseInt(a.params.flex_width,10),o=!!parseInt(a.params.flex_height,10),l=e.get("width"),d=e.get("height"),h=parseInt(a.params.width,10),p=parseInt(a.params.height,10),c=h/p,u=l,f=d;return t.set("canSkipCrop",!a.mustBeCropped(n,o,h,p,l,d)),u/f>c?h=(p=f)*c:p=(h=u)/c,s={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:l,imageHeight:d,x1:i=(u-h)/2,y1:r=(f-p)/2,x2:h+i,y2:p+r},!1===o&&!1===n&&(s.aspectRatio=h+":"+p),!1===o&&(s.maxHeight=p),!1===n&&(s.maxWidth=h),s},mustBeCropped:function(e,t,i,r,s,a){"use strict";return(!0!==e||!0!==t)&&((!0!==e||r!==a)&&((!0!==t||i!==s)&&((i!==s||r!==a)&&!(s<=i))))},onSkippedCrop:function(){"use strict";var e=this.frame.state().get("selection").first().toJSON();this.setImageInRepeaterField(e)},setImageInRepeaterField:function(e){"use strict";var t=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image");t.find(".kirki-image-attachment").html('<img src="'+e.url+'">').hide().slideDown("slow"),t.find(".hidden-field").val(e.id),this.$thisButton.text(this.$thisButton.data("alt-label")),t.find(".remove-button").show(),t.find("input, textarea, select").trigger("change"),this.frame.close()},setFileInRepeaterField:function(e){"use strict";var t=this.$thisButton.closest(".repeater-field-upload");t.find(".kirki-file-attachment").html('<span class="file"><span class="dashicons dashicons-media-default"></span> '+e.filename+"</span>").hide().slideDown("slow"),t.find(".hidden-field").val(e.id),this.$thisButton.text(this.$thisButton.data("alt-label")),t.find(".upload-button").show(),t.find(".remove-button").show(),t.find("input, textarea, select").trigger("change"),this.frame.close()},getMimeType:function(){"use strict";var e=this.$thisButton.siblings("input.hidden-field").attr("data-field");return"string"==typeof e&&""!==e&&"object"==typeof this.params.fields[e]&&"upload"===this.params.fields[e].type&&void 0!==this.params.fields[e].mime_type?this.params.fields[e].mime_type:"image"},removeImage:function(e){"use strict";var t,i;wp.customize.utils.isKeydownButNotEnterEvent(e)||(i=(t=this.$thisButton.closest(".repeater-field-image,.repeater-field-cropped_image,.repeater-field-upload")).find(".upload-button"),t.find(".kirki-image-attachment").slideUp("fast",(function(){jQuery(this).show().html(jQuery(this).data("placeholder"))})),t.find(".hidden-field").val(""),i.text(i.data("label")),this.$thisButton.hide(),t.find("input, textarea, select").trigger("change"))},removeFile:function(e){"use strict";var t,i;wp.customize.utils.isKeydownButNotEnterEvent(e)||(i=(t=this.$thisButton.closest(".repeater-field-upload")).find(".upload-button"),t.find(".kirki-file-attachment").slideUp("fast",(function(){jQuery(this).show().html(jQuery(this).data("placeholder"))})),t.find(".hidden-field").val(""),i.text(i.data("label")),this.$thisButton.hide(),t.find("input, textarea, select").trigger("change"))},getValue:function(){"use strict";return JSON.parse(decodeURI(this.setting.get()))},setValue:function(e,t,i){"use strict";var r=e,s=[];i&&(jQuery.each(this.params.fields,(function(e,t){"image"!==t.type&&"cropped_image"!==t.type&&"upload"!==t.type||s.push(e)})),jQuery.each(e,(function(e,t){jQuery.each(s,(function(i,s){void 0!==t[s]&&void 0!==t[s].id&&(r[e][s]=t[s].id)}))}))),this.setting.set(encodeURI(JSON.stringify(r))),t&&this.settingField.trigger("change")},addRow:function(e){"use strict";var t,i,r,s=this,a=s.repeaterTemplate(),n=this.getValue(),o={};if(a){if(t=jQuery.extend(!0,{},s.params.fields),e)for(r in e)e.hasOwnProperty(r)&&t.hasOwnProperty(r)&&(t[r].default=e[r]);for(r in t.index=this.currentIndex,a=a(t),(i=new RepeaterRow(s.currentIndex,jQuery(a).appendTo(s.repeaterFieldsContainer),s.params.row_label)).container.on("row:remove",(function(e,t){s.deleteRow(t)})),i.container.on("row:update",(function(e,t,r,a){s.updateField.call(s,e,t,r,a),i.updateLabel()})),this.rows[this.currentIndex]=i,t)t.hasOwnProperty(r)&&(o[r]=t[r].default);return n[this.currentIndex]=o,this.setValue(n,!0),this.currentIndex++,i}},sort:function(){"use strict";var e=this,t=this.repeaterFieldsContainer.find(".repeater-row"),i=[],r=e.getValue(),s=[],a=[];t.each((function(e,t){i.push(jQuery(t).data("row"))})),jQuery.each(i,(function(t,i){s[t]=e.rows[i],s[t].setRowIndex(t),a[t]=r[i]})),e.rows=s,e.setValue(a)},deleteRow:function(e){"use strict";var t,i=this.getValue();for(t in i[e]&&this.rows[e]&&(delete i[e],delete this.rows[e],this.setValue(i,!0)),1,this.rows)this.rows.hasOwnProperty(t)&&this.rows[t]&&(this.rows[t].updateLabel())},updateField:function(e,t,i,r){"use strict";var s,a,n;this.rows[t]&&this.params.fields[i]&&(s=this.params.fields[i].type,a=this.rows[t],n=this.getValue(),r=jQuery(r),void 0!==typeof n[a.rowIndex][i]&&(n[a.rowIndex][i]="checkbox"===s?r.is(":checked"):r.val(),this.setValue(n,!0)))},initColorPicker:function(){"use strict";var e=this,t=e.container.find(".color-picker-hex"),i={},r=t.data("field");void 0!==r&&void 0!==e.params.fields[r]&&void 0!==e.params.fields[r].palettes&&"object"==typeof e.params.fields[r].palettes&&(i.palettes=e.params.fields[r].palettes),i.change=function(t,i){var r=jQuery(t.target),s=r.closest(".repeater-row").data("row"),a=e.getValue();a[s][r.data("field")]=i.color.toString(),e.setValue(a,!0)},0!==t.length&&t.wpColorPicker(i)},initDropdownPages:function(e,t){"use strict";var i,r,s=this,a=e.container.find(".repeater-dropdown-pages select");0!==a.length&&(i=jQuery(a).selectize()[0].selectize,r=a.data("field"),t&&i.setValue(t[r]),this.container.on("change",".repeater-dropdown-pages select",(function(e){var t=jQuery(e.target),i=t.closest(".repeater-row").data("row"),r=s.getValue();r[i][t.data("field")]=jQuery(this).val(),s.setValue(r)})))}});
